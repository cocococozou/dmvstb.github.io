---
title: "The Association Between Tuberculosis and Type II Diabetes and Risk Factors in Shanghai, China"
author: "Rui Huang (rh2916), Hanbo Qiu (hq2163), Annie Yu (xy2404), Dana Zeng (dz2399), Coco Zou (xz2809)"
date: "November 8, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(incidence)
library(patchwork)
library(survival)
library(survminer)

```

###Import data:

```{r}
load("dm.RData")
```

```{r}
df_combine = dm_base %>% 
  rename(
    subject_id = JiBenCID,
    glu_average = fastglu, 
    weight_initial = tizhong_1st, 
    weight_average = tizhong, 
    height = ShenGao, 
    glu_initial = kfxt_1st,
    gender = xingbie,
    district = GuanLiQX,
    sys_pressure = Sbp,
    dia_pressure = Dbp,
    exercise_time = xiuxiansj,
    exercise = xiuxiantl,
    drug_insulin = insulin,
    drug_oral_sulfo = sulfonylurea,
    drug_oral_biguanide = biguanide,
    drug_oral_glu = glu_inhib,
    retina = reti, 
    skin = derm, 
    vessel = vesl, 
    nerve = neur,
    kidney = neph, 
    depression = depress,
    dmtime = quezhensj,
    birthyear  = birth_year,
    birthmon = birth_mon,
    dmdatayear = rucu_year,
    dmdatamon = rucu_mon,
    dmdataage = rucuage,
    drug_order = fuyaoqk) %>% 
  mutate(
    gender = factor(gender, labels = c("Male", "Female")),
    district = as.factor(district),
    glu_self_monitor = as.factor(celiangxtgl),
    bmi_initial = weight_initial/(height/100)^2, 
    bmi_average = weight_average/(height/100)^2, 
    bmi_change = bmi_average - bmi_initial,
    glu_change = glu_average - glu_initial,
    tb = as.factor(ifelse(censer == 1, "No", "Yes")),
    exercise = as.factor(exercise),
    drug_oral_name  = case_when(drug_oral_sulfo == "1" & drug_oral_biguanide == "0" & drug_oral_glu == "0" ~"sulfonylurea",
                           drug_oral_biguanide == "1" & drug_oral_sulfo == "0" & drug_oral_glu == "0" ~ "biguanide",
                           drug_oral_glu == "1" & drug_oral_biguanide == "0" & drug_oral_sulfo == "0" ~ "glu_inhib",
                           drug_oral_sulfo == "1" & drug_oral_biguanide == "1" & drug_oral_glu == "0" ~"sulfonylurea&biguanide",
                           drug_oral_biguanide == "1" & drug_oral_sulfo == "0" & drug_oral_glu == "1" ~ "biguanide&glu_inhib",
                           drug_oral_sulfo == "1" & drug_oral_biguanide == "0" & drug_oral_glu == "1" ~"sulfonylurea&glu_inhib",
                           drug_oral_sulfo == "1" & drug_oral_biguanide == "1" & drug_oral_glu == "1" ~"sulfonylurea&glu_inhib&biguanide",
                           TRUE ~ "NA"),
    drug = drug_oral_biguanide + drug_oral_biguanide + drug_oral_glu + drug_insulin,
    retina = as.numeric(retina),
    skin = as.numeric(skin),
    vessel = as.numeric(vessel),
    nerve = as.numeric(nerve),
    kidney = as.numeric(kidney),
    complications = retina + skin + vessel + nerve + kidney + depression,
    complications = as.factor(complications),
    drug_order = as.factor(drug_order)
  )


levels(df_combine$exercise) <- list('1' = 1,  '2' = 2, '3' = c(3,4))

levels(df_combine$district) <- list("Huangpu" = 310101, "Xuhui" = 310104, "Changning" = 310105, "Jingan" = 310106, "Putuo" = 310107, "Zhabei" = 310108, "Hongkou" = 310109, "Yangpu" = 310110, "Minhang" = 310112, "Baoshan" = 310113,  "Pudong" = c(310115, 10119), "Jiading" = 310114, "Jinshan" = 310116, "Songjiang" = 310117, "Qingpu" = 310118, "Fengxian" = 310120, "Chongming" = 310230)

levels(df_combine$glu_self_monitor) <- list("Yes" = 1, "No" = 2:3)

save(df_combine,file='./data/df_combine.RData')
```

### Exercise and K-M plot

Compare male and female mean for exercise by t.test

```{r}
male_exercise = df_combine %>% 
  filter(gender == "Male") %>% 
  mutate(exercise = as.numeric(exercise))
    
female_exercise = df_combine %>% 
  filter(gender == "Female") %>% 
  mutate(exercise = as.numeric(exercise))

var.test(male_exercise$exercise,female_exercise$exercise, alternative = "two.sided")

t.test(male_exercise$exercise,female_exercise$exercise, var.equal=FALSE, paired=FALSE) 
```

Compare male and female mean for exercise_time by t.test

```{r}
var.test(male_exercise$exercise_time,female_exercise$exercise_time, alternative = "two.sided")

t.test(male_exercise$exercise_time,female_exercise$exercise_time, var.equal=FALSE, paired=FALSE) 
```

Compare male and female mean for exercise_time*exercise by t.test

```{r}
male_exercise = male_exercise %>% mutate(total_exercise = exercise * exercise_time)
female_exercise = female_exercise %>% mutate(total_exerise = exercise * exercise_time)
var.test(male_exercise$total_exercise,female_exercise$total_exerise, alternative = "two.sided")
t.test(male_exercise$total_exercise,female_exercise$total_exercise, var.equal=FALSE, paired=FALSE) 
```


Make exercise distribution plot

```{r}
df_combine %>% 
  mutate(exercise = as.numeric(exercise),
         total_exercise = exercise * exercise_time,
         gender = as.factor(gender)) %>% 
  ggplot(aes(x = total_exercise, color = gender)) +
  geom_density()

df_combine %>% 
  mutate(exercise = as.numeric(exercise),
         total_exercise = exercise * exercise_time,
         gender = as.factor(gender)) %>% 
  ggplot(aes(x = gender, y = total_exercise, color = gender)) +
  geom_boxplot()

df_combine %>% 
  mutate(exercise = as.numeric(exercise),
         gender = as.factor(gender)) %>% 
  ggplot(aes( x = gender, y = exercise)) +
  geom_violin()

df_combine %>% 
  mutate(gender = as.factor(gender)) %>% 
  ggplot(aes( x = gender, y = exercise_time)) +
  geom_violin()
```

Make tb vs exercise plot

```{r}
df_combine %>% 
  mutate(exercise = as.numeric(exercise),
         total_exercise = exercise * exercise_time,
         gender = as.factor(gender)) %>% 
  ggplot(aes(x = tb, y = total_exercise, color = gender)) +
  geom_boxplot() +
  facet_grid(.~gender)

```

K-M plot

```{r}
df_combine$survival = with(df_combine, Surv(days, tb == "Yes"))

km <- survfit(survival ~ 1, data = df_combine, conf.type = "log-log")
km_by_gender <- survfit(survival ~ gender, data = df_combine, conf.type = "log-log")


ggsurvplot(km_by_gender, data = df_combine, risk.table = F, pval = T, ylab = "Probability of getting TB", ylim = c(0.9, 1.0), legend.labs = c("Male", "Female"))
```


## Incidence of tb...
```{r}

```


##Compare diabete and age...

Make a diabete-age distribution plot
```{r}
plot_dia_d<-df_combine %>% 
  mutate(dmage = as.numeric(dmage),
         gender = as.factor(gender)) %>% 
  ggplot(aes(x = dmage, fill= gender)) +
  geom_density()+
  facet_grid(.~gender)

plot_dia_v<-df_combine %>% 
  mutate(dmage = as.numeric(dmage),
         gender = as.factor(gender)) %>% 
  ggplot(aes(x = gender, y= dmage, fill=gender)) +
  geom_boxplot()

plot_dia_d+plot_dia_v


```

Make a tb-age distribution plot(QQQQQ)
```{r}
df_tbage <-df_combine %>% 
  na.omit(`_COL19`) %>% 
  rename(tbtime = `_COL19`) %>% 
  mutate(#separate(tbtime, into = c("tb_year", "tb_month", "tb_day"), sep = "-"),
         gender = as.factor(gender),
         birthyear = as.numeric(birthyear)) 
  
ggplot(df_tbage, aes(x= birthyear, y =tbtime, fill = gender)) +
 geom_violin()+
  facet_grid(.~gender)

  
  
```


Make a tb-diabete age distribution plot
```{r}
df_combine %>% 
  mutate(dmage = as.numeric(dmage),
         tb = as.factor(tb),
         gender = as.factor(gender)) %>% 
  ggplot(aes( x=dmage,y=tb,group=gender) )+ 
  scale_fill_brewer(palette = "Spectral") + 
  geom_col(aes(fill=gender))

df_combine %>% 
  mutate(dmage = as.numeric(dmage),
         gender = as.factor(gender)) %>% 
ggplot(aes(x = tb, y = dmage, color = gender)) +
  geom_boxplot()+
  facet_grid(.~gender)
```

### Explore the glucose and BMI distribution between male and female and tb status.

initial glucose distribution

```{r warning=FALSE}
df_combine %>% 
  ggplot(aes(x = gender, y = glu_initial, fill = tb)) +
  geom_boxplot() +
  scale_y_continuous(limits=c(0, 15))
```

Since the range of initial glucose is quite large, we found median and quartiles are a little higher in tb patients than in non-tb.

"average glucose" distribution

```{r warning=FALSE}
df_combine %>% 
  ggplot(aes(x = gender, y = glu_average, fill = tb)) +
  geom_boxplot() +
  scale_y_continuous(limits=c(0, 15))
```

We found median and quartiles are higher in tb patients than in non-tb. Also the range of "average glucose" in follow-up periods for tb patients is wider.

initial bmi distribution

```{r warning=FALSE}
df_combine %>% 
  ggplot(aes(x = gender, y = bmi_initial, fill = tb)) +
  geom_boxplot() +
  scale_y_continuous(limits=c(0, 40))
```

We found median and quartiles are higher in non-tb patients than in tb. 

"average bmi" distribution

```{r warning=FALSE}
df_combine %>% 
  ggplot(aes(x = gender, y = bmi_average, fill = tb)) +
  geom_boxplot() +
  scale_y_continuous(limits=c(0, 40))
```

We found median and quartiles of "average bmi" in follow-up periods are higher in non-tb patients than in tb. 

### Explore whether diabetes who regularly monitor glucose can reduce the risk of having tb in urban or rural areas

```{r message=FALSE, warning=FALSE}
df_combine %>% 
  mutate(urban_rural = as.factor(urban_rural)) %>% 
  filter(!is.na(urban_rural)) %>% 
  group_by(urban_rural) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(tb ~ gender + dmage + glu_self_monitor, data = .x, family = binomial())),
         ci = map(.x=models, ~confint(.x)),
         or = map(models, broom::tidy),
         ci = map(ci, broom::tidy)) %>% 
  select(-data,-models) %>% 
  unnest() %>% 
  filter(term == "glu_self_monitorNo") %>% 
  select(urban_rural, or = estimate, ci_low = "X2.5..", ci_high = "X97.5..") %>% 
  mutate(or = exp(or), ci_low = exp(ci_low), ci_high = exp(ci_high), urban_rural = fct_reorder(urban_rural, or)) %>% 
  ggplot(aes(x = urban_rural, y = or)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high)) +
  labs(
    title = "The estimated ORs and CIs for district in Shanghai",
    x = "District",
    y = "The estimated ORs and CIs"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(limits=c(0, 2))
```

Obtain the estimate and confidence interval of the adjusted odds ratio for having tb comparing diabetes who regularly monitor glucose to those who don't do keeping all other variables fixed in urban or rural area.

### Explore whether diabetes who regularly monitor glucose can reduce the risk of having tb within different districts

```{r message=FALSE, warning=FALSE}
df_combine %>% 
  mutate(urban_rural = as.factor(urban_rural)) %>% 
  filter(!is.na(district), !district %in% c("Xuhui", "Qingpu", "Jiading")) %>% 
  group_by(district) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(tb ~ gender + dmage + glu_self_monitor, data = .x, family = binomial())),
         ci = map(.x=models, ~confint(.x)),
         or = map(models, broom::tidy),
         ci = map(ci, broom::tidy)) %>% 
  select(-data,-models) %>% 
  unnest() %>% 
  filter(term == "glu_self_monitorNo") %>% 
  select(district, or = estimate, ci_low = "X2.5..", ci_high = "X97.5..") %>% 
  mutate(or = exp(or), ci_low = exp(ci_low), ci_high = exp(ci_high), district = fct_reorder(district, or)) %>% 
  ggplot(aes(x = district, y = or)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high)) +
  labs(
    title = "The estimated ORs and CIs for district in Shanghai",
    x = "District",
    y = "The estimated ORs and CIs"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits=c(0, 4))
```

For each district in Shanghai, obtain the estimate and confidence interval of the adjusted odds ratio for having tb comparing diabetes who regularly monitor glucose to those who don't monitor glucose regularly keeping all other variables fixed.
